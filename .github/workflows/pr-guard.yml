name: PR Guard (Freeze)
on:
  pull_request:
    paths:
      - 'docs/**'
      - 'labs/**'
      - 'scripts/**'
      - '.github/**'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Enforce docs freeze allowlist
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: |
          set -euo pipefail
          git fetch origin "$BASE_REF"
          CHANGED=$(git diff --name-only "$BASE_SHA"...HEAD || true)
          if [ -z "$CHANGED" ]; then
            exit 0
          fi
          VIOLATIONS=""
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if [[ "$file" == docs/* ]] && [[ ! "$file" =~ ^(docs/ops/|docs/receipts/) ]]; then
              VIOLATIONS+="$file"$'\n'
            fi
          done <<< "$CHANGED"
          if [ -n "$VIOLATIONS" ]; then
            echo "Docs freeze in effect. Only docs/ops/** and docs/receipts/** may change."
            echo "The following files violate the freeze:"
            echo "$VIOLATIONS"
            exit 1
          fi
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm i -g pnpm && pnpm i
      - run: pnpm guard
